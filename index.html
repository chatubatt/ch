<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos Avançado</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Marked.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos e Variáveis de Cor do App.css */
        :root {
            font-family: 'Inter', sans-serif;
            --radius: 0.625rem;
            --background: oklch(1 0 0);
            --foreground: oklch(0.145 0 0);
            --card: oklch(1 0 0);
            --card-foreground: oklch(0.145 0 0);
            --popover: oklch(1 0 0);
            --popover-foreground: oklch(0.145 0 0);
            --primary: oklch(0.205 0 0);
            --primary-foreground: oklch(0.985 0 0);
            --secondary: oklch(0.97 0 0);
            --secondary-foreground: oklch(0.205 0 0);
            --muted: oklch(0.97 0 0);
            --muted-foreground: oklch(0.556 0 0);
            --accent: oklch(0.97 0 0);
            --accent-foreground: oklch(0.205 0 0);
            --destructive: oklch(0.577 0.245 27.325);
            --border: oklch(0.922 0 0);
            --input: oklch(0.922 0 0);
            --ring: oklch(0.708 0 0);
        }

        .dark {
            --background: oklch(0.145 0 0);
            --foreground: oklch(0.985 0 0);
            --card: oklch(0.205 0 0);
            --card-foreground: oklch(0.985 0 0);
            --popover: oklch(0.205 0 0);
            --popover-foreground: oklch(0.985 0 0);
            --primary: oklch(0.922 0 0);
            --primary-foreground: oklch(0.205 0 0);
            --secondary: oklch(0.269 0 0);
            --secondary-foreground: oklch(0.985 0 0);
            --muted: oklch(0.269 0 0);
            --muted-foreground: oklch(0.708 0 0);
            --accent: oklch(0.269 0 0);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.704 0.191 22.216);
            --border: oklch(1 0 0 / 10%);
            --input: oklch(1 0 0 / 15%);
            --ring: oklch(0.556 0 0);
        }

        /* Aplicação das variáveis com Tailwind */
        body {
            background-color: var(--background);
            color: var(--foreground);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .expense-item:hover .action-buttons { opacity: 1; }
        .action-buttons { opacity: 0; transition: opacity 0.2s ease-in-out; }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .gemini-response h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .gemini-response ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .gemini-response li { margin-bottom: 0.25rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-background text-foreground antialiased">

    <!-- Tela de Login -->
    <div id="login-overlay" class="fixed inset-0 bg-background z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-card border border-border p-8 rounded-2xl shadow-lg text-center">
            <h2 class="text-3xl font-bold text-foreground mb-2">Bem-vindo!</h2>
            <p class="text-muted-foreground mb-6">Entre com seu nome de usuário e senha.</p>
            <div id="login-form">
                <input type="text" id="username-input" placeholder="Digite seu nome de usuário" class="w-full px-4 py-3 bg-input border border-border rounded-lg focus:ring-ring focus:border-ring transition mb-4 text-foreground placeholder:text-muted-foreground" required>
                <input type="password" id="password-input" placeholder="Digite sua senha" class="w-full px-4 py-3 bg-input border border-border rounded-lg focus:ring-ring focus:border-ring transition mb-4 text-foreground placeholder:text-muted-foreground" required>
                <div class="flex gap-4">
                    <button id="login-btn" class="w-full bg-primary text-primary-foreground font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition">Entrar</button>
                    <button id="signup-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition">Criar Conta</button>
                </div>
            </div>
            <div id="existing-users-container" class="mt-6">
                <h3 class="text-sm font-medium text-muted-foreground mb-2">Ou selecione um usuário:</h3>
                <div id="users-list" class="flex flex-wrap justify-center gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
            <div class="bg-card border border-border rounded-2xl shadow-lg p-6 sm:p-8">
                
                <!-- Cabeçalho -->
                <div class="flex justify-between items-start mb-8">
                    <div class="text-left">
                        <h1 class="text-3xl sm:text-4xl font-bold text-foreground">Controle de Gastos</h1>
                        <p class="text-muted-foreground mt-2">Usuário: <span id="current-user-display" class="font-semibold text-blue-500"></span></p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-secondary transition-colors" title="Alternar tema">
                            <!-- Ícone será inserido pelo JS -->
                        </button>
                        <button id="logout-btn" class="bg-destructive text-white font-semibold py-2 px-4 rounded-lg hover:opacity-90 transition text-sm">Sair</button>
                    </div>
                </div>
                
                <!-- Navegação por Abas -->
                <div class="mb-8 border-b border-border">
                    <nav class="flex space-x-4 -mb-px" aria-label="Tabs">
                        <button id="tab-lancamentos" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Lançamentos</button>
                        <button id="tab-relatorio" class="tab-button text-muted-foreground hover:text-foreground hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Relatório Anual</button>
                        <button id="tab-analise" class="tab-button text-muted-foreground hover:text-foreground hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Análise Inteligente</button>
                    </nav>
                </div>
                
                <!-- Conteúdo da Aba Lançamentos -->
                <div id="content-lancamentos">
                    <!-- Navegação de Mês -->
                     <div class="flex items-center justify-between mb-6">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-secondary transition-colors"><svg class="h-6 w-6 text-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                        <span id="current-month-display" class="font-semibold text-foreground text-xl w-48 text-center capitalize"></span>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-secondary transition-colors"><svg class="h-6 w-6 text-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    </div>
                    
                    <!-- Resumo e Gráfico -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="space-y-4">
                            <div class="bg-green-500/10 text-green-500 p-6 rounded-xl">
                                <h2 class="font-medium text-green-400">Receitas do Mês</h2>
                                <p id="total-income-month" class="text-3xl font-bold mt-1 text-green-500">R$ 0,00</p>
                            </div>
                             <div class="bg-red-500/10 text-red-500 p-6 rounded-xl">
                                <h2 class="font-medium text-red-400">Despesas do Mês</h2>
                                <p id="total-expense-month" class="text-3xl font-bold mt-1 text-red-500">R$ 0,00</p>
                            </div>
                             <div class="bg-blue-600/10 text-blue-500 p-6 rounded-xl">
                                <h2 class="font-medium text-blue-400">Saldo do Mês</h2>
                                <p id="balance-month" class="text-3xl font-bold mt-1 text-blue-500">R$ 0,00</p>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-foreground mb-4">Gastos por Categoria</h2>
                            <div class="bg-secondary p-4 rounded-lg border border-border h-[350px] relative">
                                <canvas id="category-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Formulários e Listas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Coluna da Esquerda: Formulários -->
                        <div class="space-y-6">
                            <!-- Formulário para Adicionar Gasto -->
                            <div class="bg-secondary p-4 rounded-lg border border-border" id="add-expense-section">
                                <h2 class="text-xl font-semibold text-foreground mb-4">Adicionar Gasto</h2>
                                <form id="expense-form" class="space-y-4">
                                    <input type="text" id="description" placeholder="Descrição" class="w-full bg-input border border-border rounded-lg px-4 py-2" required>
                                    <div class="flex gap-4">
                                        <input type="number" id="amount" step="0.01" min="0" placeholder="Valor (R$)" class="w-full bg-input border border-border rounded-lg px-4 py-2" required>
                                        <input type="number" id="installments" min="1" placeholder="Nº Parcelas" class="w-full bg-input border border-border rounded-lg px-4 py-2">
                                    </div>
                                    <div class="flex gap-4">
                                        <input type="date" id="date" class="w-full bg-input border border-border rounded-lg px-4 py-2" required>
                                        <select id="category" class="w-full bg-input border border-border rounded-lg px-4 py-2">
                                            <option value="Alimentação">Alimentação</option>
                                            <option value="Transporte">Transporte</option>
                                            <option value="Moradia">Moradia</option>
                                            <option value="Lazer">Lazer</option>
                                            <option value="Saúde">Saúde</option>
                                            <option value="Compras">Compras</option>
                                            <option value="Outros">Outros</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition">Adicionar Gasto</button>
                                </form>
                            </div>
                            
                            <!-- Formulário para Adicionar Receita -->
                            <div class="bg-secondary p-4 rounded-lg border border-border" id="add-income-section">
                                <h2 class="text-xl font-semibold text-foreground mb-4">Adicionar Receita</h2>
                                <form id="income-form" class="space-y-4">
                                    <input type="text" id="income-description" placeholder="Descrição" class="w-full bg-input border border-border rounded-lg px-4 py-2" required>
                                    <div class="flex gap-4">
                                        <input type="number" id="income-amount" step="0.01" min="0" placeholder="Valor (R$)" class="w-full bg-input border border-border rounded-lg px-4 py-2" required>
                                        <input type="date" id="income-date" class="w-full bg-input border border-border rounded-lg px-4 py-2" required>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition">Adicionar Receita</button>
                                </form>
                            </div>
                             <!-- Salário e Projeção Futura -->
                            <div class="bg-secondary p-4 rounded-lg border border-border">
                                <h2 class="text-xl font-semibold text-foreground mb-4">Salário & Projeção Futura</h2>
                                <div class="mb-4">
                                    <label for="salary" class="block text-sm font-medium text-muted-foreground mb-1">Seu Salário Mensal (R$)</label>
                                    <input type="number" id="salary" step="0.01" min="0" placeholder="Ex: 3000,00" class="w-full bg-input border border-border rounded-lg px-4 py-2 transition">
                                </div>
                                <div id="future-projection" class="space-y-2"></div>
                            </div>
                        </div>
                        
                        <!-- Coluna da Direita: Listas -->
                        <div class="space-y-6">
                            <div>
                                <h2 class="text-xl font-semibold text-foreground mb-4">Despesas do Mês</h2>
                                <div id="expense-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                                    <p id="empty-state" class="text-center text-muted-foreground py-6">Nenhum gasto neste mês.</p>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-foreground mb-4">Receitas do Mês</h2>
                                <div id="income-list" class="space-y-3 max-h-[200px] overflow-y-auto pr-2">
                                    <p id="empty-state-income" class="text-center text-muted-foreground py-6">Nenhuma receita neste mês.</p>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-foreground mb-4">Ações</h2>
                                <div class="grid grid-cols-2 gap-2">
                                     <button id="delete-month-btn" title="Apagar Lançamentos do Mês" class="p-2 bg-destructive/20 text-destructive rounded-lg hover:bg-destructive/30 transition">Apagar Mês</button>
                                     <button id="reset-btn" title="Zerar Tudo" class="p-2 bg-destructive text-white rounded-lg hover:opacity-90 transition">Zerar Tudo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conteúdo das outras abas -->
                <div id="content-relatorio" class="hidden">
                    <h2 class="text-2xl font-semibold text-foreground mb-6">Relatório Anual: Receitas vs. Despesas</h2>
                    <div class="mb-8 bg-secondary p-4 rounded-lg border border-border h-[400px]">
                       <canvas id="annual-chart"></canvas>
                    </div>
                </div>
                <div id="content-analise" class="hidden">
                    <h2 class="text-2xl font-semibold text-foreground mb-4">Análise Financeira com IA</h2>
                    <div class="bg-secondary p-6 rounded-lg border border-border">
                        <p class="text-muted-foreground mb-4">Obtenha insights e dicas personalizadas sobre suas finanças. A IA analisará seus dados para gerar um relatório exclusivo.</p>
                        <button id="gemini-analysis-btn" class="w-full bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2">
                            Gerar Análise
                        </button>
                        <div id="gemini-loading" class="hidden mt-6 text-center"><div class="loader"></div><p class="text-muted-foreground">Analisando seus dados...</p></div>
                        <div id="gemini-response-container" class="mt-6 prose dark:prose-invert max-w-none"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Modais -->
    <div id="success-message" class="fixed top-5 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 opacity-0 hidden transition-opacity duration-300"><p></p></div>

    <div id="reset-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-card border border-border rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-foreground mb-2">Zerar Todos os Dados?</h3>
            <p class="text-sm text-muted-foreground mb-4">Esta ação é irreversível e apagará todos os gastos e receitas deste usuário.</p>
            <div class="flex gap-4">
                <button id="cancel-reset-btn" class="w-full py-2 bg-secondary rounded-lg">Cancelar</button>
                <button id="confirm-reset-btn" class="w-full py-2 bg-destructive text-white rounded-lg">Sim, Zerar</button>
            </div>
        </div>
    </div>
    
    <div id="delete-month-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
       <div class="bg-card border border-border rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-foreground mb-2">Apagar Lançamentos do Mês?</h3>
            <p class="text-sm text-muted-foreground mb-4">Todos os dados de <span id="delete-month-name" class="font-bold"></span> serão apagados.</p>
            <div class="flex gap-4">
                <button id="cancel-delete-month-btn" class="w-full py-2 bg-secondary rounded-lg">Cancelar</button>
                <button id="confirm-delete-month-btn" class="w-full py-2 bg-destructive text-white rounded-lg">Sim, Apagar</button>
            </div>
        </div>
    </div>

    <div id="delete-recurring-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
         <div class="bg-card border border-border rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-foreground mb-2">Apagar Item Recorrente</h3>
            <p class="text-sm text-muted-foreground mb-4">Deseja apagar apenas esta ocorrência ou todas as futuras?</p>
            <div class="flex flex-col gap-3">
                <button id="deleteOne-btn" class="w-full py-2 bg-blue-600 text-white rounded-lg">Apenas Este</button>
                <button id="deleteAllFuture-btn" class="w-full py-2 bg-destructive text-white rounded-lg">Todos os Futuros</button>
                <button id="cancel-delete-recurring-btn" class="w-full py-2 bg-secondary rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-card border border-border rounded-lg shadow-lg p-6 w-full max-w-lg">
            <form id="edit-form">
                <h3 class="text-lg font-medium text-foreground mb-4" id="edit-modal-title">Editar Item</h3>
                <div class="space-y-4">
                    <input type="text" id="edit-description" class="w-full bg-input border border-border rounded-lg p-2" required>
                    <input type="number" id="edit-amount" step="0.01" class="w-full bg-input border border-border rounded-lg p-2" required>
                    <input type="date" id="edit-date" class="w-full bg-input border border-border rounded-lg p-2" required>
                    <div id="edit-category-container">
                        <select id="edit-category" class="w-full bg-input border border-border rounded-lg p-2"></select>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-edit-btn" type="button" class="py-2 px-4 bg-secondary rounded-lg">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-primary text-primary-foreground rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>


<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- ELEMENTOS DO DOM ---
    const loginOverlay = document.getElementById("login-overlay");
    const usernameInput = document.getElementById("username-input");
    const passwordInput = document.getElementById("password-input");
    const loginBtn = document.getElementById("login-btn");
    const signupBtn = document.getElementById("signup-btn");
    const usersList = document.getElementById("users-list");
    const appContainer = document.getElementById("app-container");
    const currentUserDisplay = document.getElementById("current-user-display");
    const logoutBtn = document.getElementById("logout-btn");
    const tabLancamentos = document.getElementById("tab-lancamentos");
    const tabRelatorio = document.getElementById("tab-relatorio");
    const tabAnalise = document.getElementById("tab-analise");
    const contentLancamentos = document.getElementById("content-lancamentos");
    const contentRelatorio = document.getElementById("content-relatorio");
    const contentAnalise = document.getElementById("content-analise");
    const prevMonthBtn = document.getElementById("prev-month-btn");
    const nextMonthBtn = document.getElementById("next-month-btn");
    const currentMonthDisplay = document.getElementById('current-month-display');
    const totalIncomeMonthEl = document.getElementById("total-income-month");
    const totalExpenseMonthEl = document.getElementById("total-expense-month");
    const balanceMonthEl = document.getElementById("balance-month");
    const expenseList = document.getElementById("expense-list");
    const incomeList = document.getElementById("income-list");
    const emptyState = document.getElementById("empty-state");
    const emptyStateIncome = document.getElementById("empty-state-income");
    const expenseForm = document.getElementById("expense-form");
    const incomeForm = document.getElementById("income-form");
    const salaryInput = document.getElementById("salary");
    const resetBtn = document.getElementById("reset-btn");
    const resetModal = document.getElementById("reset-modal");
    const confirmResetBtn = document.getElementById("confirm-reset-btn");
    const cancelResetBtn = document.getElementById("cancel-reset-btn");
    const geminiAnalysisBtn = document.getElementById("gemini-analysis-btn");
    const geminiLoading = document.getElementById("gemini-loading");
    const geminiResponseContainer = document.getElementById("gemini-response-container");
    const editModal = document.getElementById("edit-modal");
    const editForm = document.getElementById("edit-form");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const editModalTitle = document.getElementById("edit-modal-title");
    const editCategoryContainer = document.getElementById("edit-category-container");
    const deleteMonthBtn = document.getElementById("delete-month-btn");
    const deleteMonthModal = document.getElementById("delete-month-modal");
    const confirmDeleteMonthBtn = document.getElementById("confirm-delete-month-btn");
    const cancelDeleteMonthBtn = document.getElementById("cancel-delete-month-btn");
    const deleteMonthNameSpan = document.getElementById("delete-month-name");
    const deleteRecurringModal = document.getElementById("delete-recurring-modal");
    const deleteOneBtn = document.getElementById("deleteOne-btn");
    const deleteAllFutureBtn = document.getElementById("deleteAllFuture-btn");
    const cancelDeleteRecurringBtn = document.getElementById("cancel-delete-recurring-btn");
    const successMessage = document.getElementById("success-message");
    const themeToggleBtn = document.getElementById("theme-toggle-btn");

    // --- ESTADO DA APLICAÇÃO ---
    let currentUser = null;
    let users = [];
    let annualChart = null;
    let categoryChart = null;
    let editingItem = { id: null, type: null };
    let itemToDelete = { id: null, type: null };
    let expenses = [];
    let incomes = [];
    let salary = 0;
    let currentDate = new Date();
    currentDate.setDate(1);

    // --- LÓGICA DE LOGIN E DADOS ---
    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    const loadUsers = () => {
        users = JSON.parse(localStorage.getItem("app_users_secure")) || [];
        usersList.innerHTML = "";
        users.forEach(user => {
            const userButton = document.createElement("button");
            userButton.className = "bg-secondary text-foreground font-medium py-2 px-4 rounded-lg hover:bg-accent";
            userButton.textContent = user.username;
            userButton.onclick = () => {
                usernameInput.value = user.username;
                passwordInput.focus();
            };
            usersList.appendChild(userButton);
        });
    };

    const saveUsers = () => localStorage.setItem("app_users_secure", JSON.stringify(users));
    const saveData = () => {
        if (!currentUser) return;
        localStorage.setItem(`data_${currentUser}`, JSON.stringify({ expenses, incomes, salary }));
    };

    const loadUserData = () => {
        const userData = JSON.parse(localStorage.getItem(`data_${currentUser}`));
        if (userData) {
            expenses = userData.expenses || [];
            incomes = userData.incomes || [];
            salary = userData.salary || 0;
        } else {
            expenses = generateDefaultExpenses();
            incomes = [];
            salary = 0;
        }
        salaryInput.value = salary > 0 ? salary : "";
    };

    const performLogin = (username) => {
        currentUser = username;
        sessionStorage.setItem("currentUser", currentUser);
        initializeApp();
    };

    const logout = () => {
        sessionStorage.removeItem("currentUser");
        location.reload();
    };

    const initializeApp = () => {
        loginOverlay.classList.add("hidden");
        appContainer.classList.remove("hidden");
        currentUserDisplay.textContent = currentUser;
        loadUserData();
        renderAll();
    };

    // --- FUNÇÕES AUXILIARES ---
    const formatCurrency = (value) => value.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    const formatMonthYear = (date) => date.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
    const getISODate = (date) => date.toISOString().split("T")[0];

    const generateDefaultExpenses = () => {
        const defaultData = [];
        const addRecurring = (description, amount, category, start, months) => {
            const startDate = new Date(start);
            for (let i = 0; i < months; i++) {
                const date = new Date(startDate);
                date.setUTCMonth(startDate.getUTCMonth() + i);
                defaultData.push({ id: `pre_${description.replace(/\s/g, "")}_${i}`, description: `${description}`, amount, category, date: getISODate(date) });
            }
        };
        const baseDate = "2025-10-01T12:00:00Z";
        addRecurring("Acordo Tia Miciada", 48.47, "Moradia", baseDate, 36);
        addRecurring("Condominio", 500.00, "Moradia", baseDate, 36);
        addRecurring("Apartamento", 1296.35, "Moradia", baseDate, 36);
        addRecurring("Netflix", 25.00, "Lazer", baseDate, 36);
        addRecurring("Alimentação Mensal", 300.00, "Alimentação", baseDate, 36);
        return defaultData;
    };

    const motivationalMessages = [
        "Cada gasto consciente é um passo para seus objetivos!",
        "Você está no controle das suas finanças. Continue assim!",
        "Pequenas economias geram grandes resultados. Bom trabalho!",
    ];

    const showSuccessMessage = (message) => {
        successMessage.querySelector("p").textContent = message;
        successMessage.classList.remove("hidden", "opacity-0");
        successMessage.classList.add("opacity-100");
        setTimeout(() => {
            successMessage.classList.remove("opacity-100");
            successMessage.classList.add("opacity-0", "hidden");
        }, 3000);
    };

    // --- FUNÇÕES DE RENDERIZAÇÃO ---
    const renderAll = () => {
        renderMonthDisplay();
        renderMonthlyBreakdown();
        renderCategoryChart();
        renderProjection();
        if(!contentRelatorio.classList.contains('hidden')) renderAnnualReport();
    };
    
    const renderMonthDisplay = () => currentMonthDisplay.textContent = formatMonthYear(currentDate);

    const renderMonthlyBreakdown = () => {
        const filteredExpenses = expenses.filter(exp => {
            const expDate = new Date(exp.date + "T00:00:00");
            return expDate.getFullYear() === currentDate.getFullYear() && expDate.getMonth() === currentDate.getMonth();
        });
        expenseList.innerHTML = "";
        if (filteredExpenses.length === 0) {
            expenseList.innerHTML = `<p id="empty-state" class="text-center text-muted-foreground py-6">Nenhum gasto neste mês.</p>`;
        } else {
            filteredExpenses.sort((a,b) => a.description.localeCompare(b.description)).forEach(expense => {
                const item = document.createElement("div");
                item.className = "expense-item flex items-center justify-between bg-secondary p-3 rounded-lg border border-border";
                item.innerHTML = `<div><p class="font-semibold text-foreground">${expense.description}</p><p class="text-xs text-muted-foreground">${expense.category}</p></div><div class="flex items-center gap-2"><p class="font-semibold text-foreground text-right">${formatCurrency(expense.amount)}</p><div class="action-buttons flex items-center"><button onclick="openEditModal('expense', '${expense.id}')" class="p-1 text-blue-500 hover:bg-accent rounded-full">...</button><button onclick="deleteItem('expense', '${expense.id}')" class="p-1 text-red-500 hover:bg-accent rounded-full">...</button></div></div>`;
                expenseList.appendChild(item);
            });
        }

        const filteredIncomes = incomes.filter(inc => {
            const incDate = new Date(inc.date + "T00:00:00");
            return incDate.getFullYear() === currentDate.getFullYear() && incDate.getMonth() === currentDate.getMonth();
        });
        incomeList.innerHTML = "";
         if (filteredIncomes.length === 0) {
            incomeList.innerHTML = `<p id="empty-state-income" class="text-center text-muted-foreground py-6">Nenhuma receita neste mês.</p>`;
        } else {
            filteredIncomes.sort((a,b) => a.description.localeCompare(b.description)).forEach(income => {
                const item = document.createElement("div");
                item.className = "expense-item flex items-center justify-between bg-green-500/10 p-3 rounded-lg border border-green-500/20";
                item.innerHTML = `<div><p class="font-semibold text-foreground">${income.description}</p></div><div class="flex items-center gap-2"><p class="font-semibold text-green-500 text-right">${formatCurrency(income.amount)}</p><div class="action-buttons flex items-center"><button onclick="openEditModal('income', '${income.id}')" class="p-1 text-blue-500 hover:bg-accent rounded-full">...</button><button onclick="deleteItem('income', '${income.id}')" class="p-1 text-red-500 hover:bg-accent rounded-full">...</button></div></div>`;
                incomeList.appendChild(item);
            });
        }
        
        const totalExpenses = filteredExpenses.reduce((acc, expense) => acc + expense.amount, 0);
        const totalOtherIncomes = filteredIncomes.reduce((acc, income) => acc + income.amount, 0);
        const totalIncomes = (salary || 0) + totalOtherIncomes;
        const balance = totalIncomes - totalExpenses;

        totalIncomeMonthEl.textContent = formatCurrency(totalIncomes);
        totalExpenseMonthEl.textContent = formatCurrency(totalExpenses);
        balanceMonthEl.textContent = formatCurrency(balance);
    };

    const renderCategoryChart = () => {
        const chartCanvas = document.getElementById("category-chart").getContext("2d");
        const filteredExpenses = expenses.filter(exp => new Date(exp.date + "T00:00:00").getFullYear() === currentDate.getFullYear() && new Date(exp.date + "T00:00:00").getMonth() === currentDate.getMonth());
        
        if (categoryChart) categoryChart.destroy();
        
        if (filteredExpenses.length === 0) return;

        const expensesByCategory = filteredExpenses.reduce((acc, exp) => {
            acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
            return acc;
        }, {});

        categoryChart = new Chart(chartCanvas, {
            type: "doughnut",
            data: {
                labels: Object.keys(expensesByCategory),
                datasets: [{ data: Object.values(expensesByCategory) }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    };

    const renderProjection = () => {
        futureProjectionEl.innerHTML = "";
        if (salary <= 0) {
            futureProjectionEl.innerHTML = `<p class="text-sm text-muted-foreground">Informe seu salário para ver a projeção.</p>`;
            return;
        }
        for (let i = 0; i < 6; i++) {
            const projDate = new Date(currentDate);
            projDate.setMonth(currentDate.getMonth() + i);
            const monthlyExpenses = expenses.filter(e => new Date(e.date + "T00:00:00").getFullYear() === projDate.getFullYear() && new Date(e.date + "T00:00:00").getMonth() === projDate.getMonth()).reduce((s, e) => s + e.amount, 0);
            const monthlyIncomes = incomes.filter(inc => new Date(inc.date + "T00:00:00").getFullYear() === projDate.getFullYear() && new Date(inc.date + "T00:00:00").getMonth() === projDate.getMonth()).reduce((s, i) => s + i.amount, 0);
            const balance = (salary || 0) + monthlyIncomes - monthlyExpenses;
            
            futureProjectionEl.innerHTML += `<div class="flex justify-between items-center text-sm py-1"><span class="text-muted-foreground capitalize">${formatMonthYear(projDate)}</span><span class="font-semibold ${balance >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(balance)}</span></div>`;
        }
    };
    
    const renderAnnualReport = () => {
        const chartCanvas = document.getElementById("annual-chart").getContext("2d");
        if (annualChart) annualChart.destroy();
        
        const year = currentDate.getFullYear();
        const monthlyData = Array(12).fill(0).map(() => ({ income: salary, expense: 0 }));
        
        expenses.forEach(e => {
            const d = new Date(e.date + "T00:00:00");
            if (d.getFullYear() === year) monthlyData[d.getMonth()].expense += e.amount;
        });
        incomes.forEach(i => {
            const d = new Date(i.date + "T00:00:00");
            if (d.getFullYear() === year) monthlyData[d.getMonth()].income += i.amount;
        });

        annualChart = new Chart(chartCanvas, {
            type: "bar",
            data: {
                labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
                datasets: [
                    { label: "Receitas", data: monthlyData.map(d => d.income), backgroundColor: "rgba(16, 185, 129, 0.7)" },
                    { label: "Despesas", data: monthlyData.map(d => d.expense), backgroundColor: "rgba(239, 68, 68, 0.7)" },
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    };

    // --- MANIPULADORES DE EVENTOS ---
    expenseForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const description = document.getElementById("description").value;
        const amount = parseFloat(document.getElementById("amount").value);
        const installments = parseInt(document.getElementById("installments").value) || 1;
        const date = document.getElementById("date").value;
        const category = document.getElementById("category").value;
        const installmentAmount = amount / installments;
        
        for (let i = 0; i < installments; i++) {
            const expenseDate = new Date(date + "T00:00:00");
            expenseDate.setUTCMonth(expenseDate.getUTCMonth() + i);
            expenses.push({ id: `item_${Date.now()}_${i}`, description, amount: installmentAmount, category, date: getISODate(expenseDate) });
        }
        saveData();
        expenseForm.reset();
        renderAll();
        showSuccessMessage(motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)]);
    });

    incomeForm.addEventListener("submit", (e) => {
        e.preventDefault();
        incomes.push({ id: `item_${Date.now()}`, description: document.getElementById("income-description").value, amount: parseFloat(document.getElementById("income-amount").value), date: document.getElementById("income-date").value });
        saveData();
        incomeForm.reset();
        renderAll();
    });

    window.openEditModal = (type, id) => {
        editingItem = { type, id };
        let item = type === "expense" ? expenses.find(e => e.id === id) : incomes.find(i => i.id === id);
        
        if (item) {
            document.getElementById("edit-description").value = item.description;
            document.getElementById("edit-amount").value = item.amount;
            document.getElementById("edit-date").value = item.date;
            editCategoryContainer.style.display = type === 'expense' ? 'block' : 'none';
            if (type === 'expense') document.getElementById("edit-category").value = item.category;
            editModal.classList.remove("hidden");
        }
    };

    editForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const list = editingItem.type === "expense" ? expenses : incomes;
        const index = list.findIndex(item => item.id === editingItem.id);
        if (index > -1) {
            list[index] = {
                ...list[index],
                description: document.getElementById("edit-description").value,
                amount: parseFloat(document.getElementById("edit-amount").value),
                date: document.getElementById("edit-date").value,
                ...(editingItem.type === "expense" && { category: document.getElementById("edit-category").value })
            };
        }
        saveData();
        editModal.classList.add("hidden");
        renderAll();
    });

    window.deleteItem = (type, id) => {
        itemToDelete = { type, id };
        const item = (type === "expense" ? expenses : incomes).find(i => i.id === id);
        if (item && item.id.startsWith("pre_")) {
            deleteRecurringModal.classList.remove("hidden");
        } else {
            if (confirm("Tem certeza que deseja apagar este item?")) {
                if (type === "expense") expenses = expenses.filter(e => e.id !== id);
                else incomes = incomes.filter(i => i.id !== id);
                saveData();
                renderAll();
            }
        }
    };
    
    // --- INICIALIZAÇÃO ---
    const activateTab = (tabName) => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active", "text-blue-600", "border-blue-500"));
        document.querySelectorAll("[id^='content-']").forEach(c => c.classList.add("hidden"));
        const tab = document.getElementById(`tab-${tabName}`);
        tab.classList.add("active", "text-blue-600", "border-blue-500");
        document.getElementById(`content-${tabName}`).classList.remove("hidden");
        if (tabName === "relatorio") renderAnnualReport();
    };

    const setupEventListeners = () => {
        loginBtn.addEventListener("click", async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const hashedPassword = await hashPassword(password);
            const user = users.find(u => u.username === username && u.passwordHash === hashedPassword);
            if (user) performLogin(username); else alert("Usuário ou senha incorretos.");
        });

        signupBtn.addEventListener("click", async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if (users.some(u => u.username === username)) return alert("Usuário já existe.");
            users.push({ username, passwordHash: await hashPassword(password) });
            saveUsers();
            loadUsers();
            alert("Conta criada! Pode iniciar sessão.");
        });
        
        logoutBtn.addEventListener("click", logout);
        prevMonthBtn.addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(); });
        nextMonthBtn.addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(); });
        tabLancamentos.addEventListener("click", () => activateTab("lancamentos"));
        tabRelatorio.addEventListener("click", () => activateTab("relatorio"));
        tabAnalise.addEventListener("click", () => activateTab("analise"));
        salaryInput.addEventListener("change", (e) => { salary = parseFloat(e.target.value) || 0; saveData(); renderAll(); });
        
        // Modals
        resetBtn.addEventListener("click", () => resetModal.classList.remove("hidden"));
        confirmResetBtn.addEventListener("click", () => { localStorage.removeItem(`data_${currentUser}`); initializeApp(); resetModal.classList.add("hidden"); });
        cancelResetBtn.addEventListener("click", () => resetModal.classList.add("hidden"));
        
        cancelEditBtn.addEventListener("click", () => editModal.classList.add("hidden"));

        deleteMonthBtn.addEventListener("click", () => { deleteMonthNameSpan.textContent = formatMonthYear(currentDate); deleteMonthModal.classList.remove("hidden"); });
        confirmDeleteMonthBtn.addEventListener("click", () => {
            expenses = expenses.filter(e => new Date(e.date + "T00:00:00").getFullYear() !== currentDate.getFullYear() || new Date(e.date + "T00:00:00").getMonth() !== currentDate.getMonth());
            incomes = incomes.filter(i => new Date(i.date + "T00:00:00").getFullYear() !== currentDate.getFullYear() || new Date(i.date + "T00:00:00").getMonth() !== currentDate.getMonth());
            saveData();
            deleteMonthModal.classList.add("hidden");
            renderAll();
        });
        cancelDeleteMonthBtn.addEventListener("click", () => deleteMonthModal.classList.add("hidden"));

        deleteOneBtn.addEventListener("click", () => {
            if (itemToDelete.type === "expense") expenses = expenses.filter(e => e.id !== itemToDelete.id);
            else incomes = incomes.filter(i => i.id !== itemToDelete.id);
            saveData(); deleteRecurringModal.classList.add("hidden"); renderAll();
        });
        deleteAllFutureBtn.addEventListener("click", () => {
            const item = (itemToDelete.type === "expense" ? expenses : incomes).find(i => i.id === itemToDelete.id);
            if (item) {
                const itemDate = new Date(item.date + "T00:00:00");
                const baseId = item.id.substring(0, item.id.lastIndexOf("_"));
                if (itemToDelete.type === "expense") expenses = expenses.filter(e => !(e.id.startsWith(baseId) && new Date(e.date + "T00:00:00") >= itemDate));
                else incomes = incomes.filter(i => !(i.id.startsWith(baseId) && new Date(i.date + "T00:00:00") >= itemDate));
                saveData(); deleteRecurringModal.classList.add("hidden"); renderAll();
            }
        });
        cancelDeleteRecurringBtn.addEventListener("click", () => deleteRecurringModal.classList.add("hidden"));

        geminiAnalysisBtn.addEventListener("click", async () => {
            geminiAnalysisBtn.disabled = true;
            geminiLoading.classList.remove("hidden");
            geminiResponseContainer.innerHTML = "";

            // ATENÇÃO: Substitua 'SUA_CHAVE_API_GEMINI' pela sua chave de API real.
            // É recomendado não colocar chaves de API diretamente no código em produção.
            const GEMINI_API_KEY = 'SUA_CHAVE_API_GEMINI';
            if (GEMINI_API_KEY === 'SUA_CHAVE_API_GEMINI' || !GEMINI_API_KEY) {
                geminiResponseContainer.innerHTML = `<p class="text-red-500">Por favor, configure sua chave de API Gemini no código.</p>`;
            } else {
                 const prompt = `Analise os dados financeiros de um usuário para o ano de ${currentDate.getFullYear()}: Salário Mensal: ${formatCurrency(salary)}. Transações: ${[...expenses, ...incomes].map(t => `${t.category ? 'Gasto' : 'Receita'}: ${t.description} - ${formatCurrency(t.amount)} em ${t.date}`).join(", ")}. Forneça um resumo, principais gastos, sugestões para economizar, e pontos fortes/fracos. Formate em Markdown.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }]})
                    });
                    const data = await response.json();
                    geminiResponseContainer.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
                } catch (error) {
                    geminiResponseContainer.innerHTML = `<p class="text-red-500">Erro ao gerar análise. Tente novamente.</p>`;
                }
            }
            geminiLoading.classList.add("hidden");
            geminiAnalysisBtn.disabled = false;
        });

        const setupTheme = () => {
            const isDark = localStorage.getItem('theme') === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            themeToggleBtn.innerHTML = isDark ? `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>` : `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
        };
        themeToggleBtn.addEventListener("click", () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            setupTheme();
        });
        setupTheme();
    };

    // Ponto de entrada
    loadUsers();
    const storedUser = sessionStorage.getItem("currentUser");
    if (storedUser) {
        performLogin(storedUser);
    } else {
        loginOverlay.classList.remove("hidden");
    }
    setupEventListeners();
    
    // Define a data padrão para hoje
    const todayFormatted = getISODate(new Date());
    document.getElementById("date").value = todayFormatted;
    document.getElementById("income-date").value = todayFormatted;
});
</script>
</body>
</html>
