<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Gastos Avançado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .expense-item:hover .action-buttons {
            opacity: 1;
        }
        .action-buttons {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .gemini-response h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .gemini-response ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .gemini-response li {
            margin-bottom: 0.25rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .login-card {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Tela de Login -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-100 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg text-center login-card">
            <div class="mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Bem-vindo!</h2>
                <p class="text-gray-500">Entre com seu nome de utilizador e senha</p>
            </div>
            
            <div id="login-form">
                <div class="mb-4">
                    <input type="text" id="username-input" placeholder="Digite seu nome de utilizador" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                    <p id="username-error" class="text-red-500 text-sm text-left mt-1 hidden">Por favor, informe um nome de utilizador</p>
                </div>
                <div class="mb-6">
                    <input type="password" id="password-input" placeholder="Digite sua senha" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" required>
                    <p id="password-error" class="text-red-500 text-sm text-left mt-1 hidden">Por favor, informe uma senha</p>
                </div>
                <div class="flex gap-4">
                    <button id="login-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                        Entrar
                    </button>
                    <button id="signup-btn" class="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
                        Criar Conta
                    </button>
                </div>
            </div>
            
            <div id="login-message" class="mt-4 p-3 rounded-lg hidden"></div>
            
            <div id="existing-users-container" class="mt-6">
                <h3 class="text-sm font-medium text-gray-500 mb-2">Ou selecione um utilizador existente:</h3>
                <div id="users-list" class="flex flex-wrap justify-center gap-2">
                    <!-- Utilizadores existentes serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="hidden">
        <!-- O resto do código da aplicação permanece igual -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DO DOM ---
            const loginOverlay = document.getElementById('login-overlay');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const usernameError = document.getElementById('username-error');
            const passwordError = document.getElementById('password-error');
            const loginMessage = document.getElementById('login-message');
            const usersList = document.getElementById('users-list');
            const logoutBtn = document.getElementById('logout-btn');
            const currentUserDisplay = document.getElementById('current-user-display');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            
            // --- LÓGICA DE LOGIN ---

            // Função hashPassword corrigida
            async function hashPassword(password) {
                // Converta a senha para um array de bytes
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                
                // Use a API de criptografia do navegador
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                
                // Converta o buffer para uma string hexadecimal
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return hashHex;
            }

            const loadUsers = () => {
                users = JSON.parse(localStorage.getItem('app_users_secure')) || [];
                usersList.innerHTML = '';
                
                if (users.length === 0) {
                    document.getElementById('existing-users-container').classList.add('hidden');
                    return;
                }
                
                document.getElementById('existing-users-container').classList.remove('hidden');
                
                users.forEach(user => {
                    const userButton = document.createElement('button');
                    userButton.className = 'bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition';
                    userButton.textContent = user.username;
                    userButton.onclick = () => {
                        usernameInput.value = user.username;
                        passwordInput.focus();
                    };
                    usersList.appendChild(userButton);
                });
            };

            const saveUsers = () => {
                localStorage.setItem('app_users_secure', JSON.stringify(users));
            };

            const showLoginError = (message) => {
                loginMessage.textContent = message;
                loginMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                loginMessage.classList.add('bg-red-100', 'text-red-700');
                loginForm.classList.add('shake');
                setTimeout(() => {
                    loginForm.classList.remove('shake');
                }, 500);
            };

            const showLoginSuccess = (message) => {
                loginMessage.textContent = message;
                loginMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                loginMessage.classList.add('bg-green-100', 'text-green-700');
            };

            const validateForm = () => {
                let isValid = true;
                
                if (!usernameInput.value.trim()) {
                    usernameError.classList.remove('hidden');
                    isValid = false;
                } else {
                    usernameError.classList.add('hidden');
                }
                
                if (!passwordInput.value) {
                    passwordError.classList.remove('hidden');
                    isValid = false;
                } else {
                    passwordError.classList.add('hidden');
                }
                
                return isValid;
            };

            const performLogin = (username) => {
                currentUser = username;
                sessionStorage.setItem('currentUser', currentUser);
                initializeApp();
            };

            const logout = () => {
                sessionStorage.removeItem('currentUser');
                location.reload();
            };

            const initializeApp = () => {
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                currentUserDisplay.textContent = currentUser;
                loadUserData();
                renderAll();
            };

            loginBtn.addEventListener('click', async () => {
                if (!validateForm()) return;
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                
                try {
                    const user = users.find(u => u.username === username);
                    if (!user) {
                        showLoginError('Utilizador não encontrado.');
                        return;
                    }
                    
                    const passwordHash = await hashPassword(password);
                    if (passwordHash === user.passwordHash) {
                        showLoginSuccess('Login realizado com sucesso!');
                        setTimeout(() => performLogin(username), 1000);
                    } else {
                        showLoginError('Senha incorreta.');
                    }
                } catch (error) {
                    console.error('Erro no login:', error);
                    showLoginError('Erro durante o login. Tente novamente.');
                }
            });

            signupBtn.addEventListener('click', async () => {
                if (!validateForm()) return;
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                
                try {
                    const existingUser = users.find(u => u.username === username);
                    if (existingUser) {
                        showLoginError('Este nome de utilizador já existe.');
                        return;
                    }

                    const passwordHash = await hashPassword(password);
                    users.push({ username, passwordHash });
                    saveUsers();
                    showLoginSuccess(`Utilizador "${username}" criado com sucesso!`);
                    setTimeout(() => performLogin(username), 1000);
                } catch (error) {
                    console.error('Erro ao criar conta:', error);
                    showLoginError('Erro ao criar conta. Tente novamente.');
                }
            });

            // Carregar usuários existentes ao iniciar
            loadUsers();
            
            // Verificar se já está logado
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                currentUser = sessionUser;
                initializeApp();
            }
            
            // Focar no campo de usuário ao carregar a página
            usernameInput.focus();
            
            // Permitir login com Enter
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        });
    </script>
</body>
</html>
